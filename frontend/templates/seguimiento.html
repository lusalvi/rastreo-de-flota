<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seguimiento de Ruta - GeoBuild S.A.</title>
  <link rel="stylesheet" href="../css/bootstrap.css">
  <link rel="stylesheet" href="../css/costume.css">
  <link rel="stylesheet" href="../css/cruds.css">
  <link rel="manifest" href="/frontend/manifest.json">
  <meta name="theme-color" content="#004643">
  <style>
    #map {
      height: 400px;
      width: 100%;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .alert {
      font-size: 0.95rem;
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>
</head>
<body>
  <div class="container">
    <header class="d-flex align-items-center justify-content-between py-3 mb-4 border-bottom">
      <a href="#" class="navbar-brand d-flex align-items-center">
        <img src="../img/iconoSF.png" alt="Logo" class="img-fluid" style="max-height: 50px;">
        <span class="fs-5">GeoBuild S.A.</span>
      </a>
    </header>
  </div>

  <main class="container">
    <div class="alert alert-info" id="estado">Inicializando...</div>
    <div id="map"></div>
  </main>

  <footer class="py-3 my-4 border-top">
    <div class="container text-center">
      <p class="text-muted mb-0">&copy; 2025 GeoBuild S.A.</p>
    </div>
  </footer>

  <script>
    const dni = new URLSearchParams(window.location.search).get('dni');
    if (!dni) {
      document.getElementById('estado').textContent = 'Acceso inválido: falta el DNI en la URL.';
      throw new Error("Falta DNI");
    }

    const API_URL = 'https://sistema-de-rastreo-de-flotas.onrender.com/api';
    let map, markerConductor;

    async function obtenerConductor(dni) {
      const res = await fetch(`${API_URL}/conductores/${dni}`);
      if (!res.ok) throw new Error('Conductor no encontrado');
      return res.json();
    }

    async function obtenerParadas(patente) {
      const res = await fetch(`${API_URL}/pasajeros`);
      const data = await res.json();
      return data.filter(p => p.vehiculoasignado === patente);
    }

    function initMap(lat, lng) {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat, lng },
        zoom: 13,
      });
      markerConductor = new google.maps.Marker({
        position: { lat, lng },
        map,
        icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
        title: 'Tu ubicación'
      });
    }

    function actualizarUbicacion(lat, lng) {
      markerConductor.setPosition({ lat, lng });
      map.setCenter({ lat, lng });

      // Enviar ubicación al backend
      fetch(`${API_URL}/ubicacion`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          dni: dni,
          latitud: lat,
          longitud: lng,
          timestamp: new Date().toISOString()
        })
      }).catch(err => console.error('Error enviando ubicación:', err));
    }

    async function trazarRuta(origen, paradas) {
      const directionsService = new google.maps.DirectionsService();
      const directionsRenderer = new google.maps.DirectionsRenderer({ map });

      const waypoints = paradas.slice(0, -1).map(p => ({
        location: { lat: p.latitud, lng: p.longitud },
        stopover: true
      }));

      directionsService.route({
        origin: origen,
        destination: paradas[paradas.length - 1],
        waypoints,
        travelMode: google.maps.TravelMode.DRIVING
      }, (result, status) => {
        if (status === 'OK') {
          directionsRenderer.setDirections(result);
        } else {
          console.error('Error al trazar ruta:', status);
        }
      });
    }

    async function main() {
      try {
        const conductor = await obtenerConductor(dni);
        if (!conductor.vehiculo) {
          document.getElementById('estado').textContent = 'No tenés vehículo asignado. Contactá a administración.';
          return;
        }

        const pasajeros = await obtenerParadas(conductor.vehiculo);
        const paradas = pasajeros.map(p => ({
          latitud: parseFloat(p.latitud),
          longitud: parseFloat(p.longitud)
        }));

        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          initMap(lat, lng);

          if (paradas.length) {
            trazarRuta({ lat, lng }, paradas);
          }

          document.getElementById('estado').textContent = 'Ruta cargada correctamente';

          navigator.geolocation.watchPosition(pos => {
            actualizarUbicacion(pos.coords.latitude, pos.coords.longitude);
          }, err => {
            console.error('Error en seguimiento:', err);
          }, { enableHighAccuracy: true });

        }, err => {
          document.getElementById('estado').textContent = 'No se pudo obtener tu ubicación';
        });

      } catch (err) {
        console.error(err);
        document.getElementById('estado').textContent = err.message;
      }
    }

    main();
  </script>
</body>
</html>
